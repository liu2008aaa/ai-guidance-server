<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Qwen + LangChain4j Stream Chat (Markdown)</title>
    <!-- å¼•å…¥ Markdown è§£æåº“å’Œå®‰å…¨å‡€åŒ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f7fa; }
        .chat-container { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 10px 15px; border-radius: 8px; max-width: 80%; line-height: 1.6; word-wrap: break-word; }
        .user { align-self: flex-end; background: #007bff; color: white; }
        .ai { align-self: flex-start; background: #e9ecef; color: #333; }
        .input-area { margin-top: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        button { padding: 12px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
        .config { margin-bottom: 15px; font-size: 0.9em; color: #666; }

        /* ä¼˜åŒ– Markdown æ¸²æŸ“æ ·å¼ - ä¸ºæ‰€æœ‰æ¶ˆæ¯ç»Ÿä¸€è®¾ç½® */
        .message img { max-width: 100%; border-radius: 4px; }
        .message pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .message code { font-family: 'Courier New', monospace; background: #f1f3f5; padding: 2px 4px; border-radius: 3px; }
        .message blockquote { border-left: 3px solid #007bff; padding-left: 10px; margin-left: 0; color: #555; }
        .message h1, .message h2, .message h3, .message h4 { margin-top: 0.5em; margin-bottom: 0.3em; }
        .message ul, .message ol { padding-left: 1.5em; margin: 0.5em 0; }
        .message li { margin: 0.2em 0; }
        .message p { margin: 0.5em 0; }

        /* ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ Markdown ç‰¹æ®Šæ ·å¼ */
        .message.user code { background: rgba(255,255,255,0.3); }
        .message.user pre { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .message.user blockquote { border-left-color: rgba(255,255,255,0.7); color: rgba(255,255,255,0.9); }

        /* AI æ¶ˆæ¯ä¸­çš„ Markdown ç‰¹æ®Šæ ·å¼ */
        .message.ai code { background: #f1f3f5; color: #d63384; }
        .message.ai pre { background: #f8f9fa; border: 1px solid #e9ecef; }
        .message.ai blockquote { background: rgba(0,123,255,0.05); padding: 5px 10px; }
    </style>
</head>
<body>

<h2>ğŸ¤– LangChain4j + Qwen Chat (Markdown)</h2>

<div class="config">
    å½“å‰ä¼šè¯ ID: <span id="chatIdDisplay" style="font-weight:bold"></span>
    <button onclick="resetChat()" style="padding: 5px 10px; font-size: 0.8em; margin-left: 10px; background: #6c757d;">é‡ç½®ä¼šè¯</button>
</div>

<div class="chat-container" id="chatBox">
    <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯æ”¹ä¸º JS åŠ¨æ€æ·»åŠ ï¼Œç¡®ä¿æ”¯æŒ Markdown -->
</div>

<div class="input-area">
    <input type="text" id="msgInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." onkeypress="if(event.keyCode==13) sendMsg()">
    <button onclick="sendMsg()" id="sendBtn">å‘é€</button>
</div>

<script>
    // é…ç½® markedï¼šå¯ç”¨ GitHub é£æ ¼ Markdown å’Œå•æ¢è¡Œè½¬ <br>
    marked.setOptions({
        breaks: true,  // å•æ¢è¡Œè½¬ <br>
        gfm: true      // å¯ç”¨ GitHub Flavored Markdown
    });

    // ç”Ÿæˆæˆ–è·å–éšæœº ChatId
    let chatId = 'user_' + Math.random().toString(36).substr(2, 9);
    //let chatId = localStorage.getItem('chatId') || 'user_' + Math.random().toString(36).substr(2, 9);
    //localStorage.setItem('chatId', chatId);
    document.getElementById('chatIdDisplay').innerText = chatId;

    // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯ï¼ˆæ”¯æŒ Markdownï¼‰
    window.addEventListener('load', () => {
        appendMessage('ai', 'ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯é€šä¹‰åƒé—®åŠ©æ‰‹ï¼Œæ”¯æŒ **Markdown** æ ¼å¼è¾“å‡ºï¼š\n- ä»£ç å— ```java System.out.println("Hello"); ```\n- åˆ—è¡¨ã€é“¾æ¥ç­‰\næœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ ï¼Ÿ');
    });

    function resetChat() {
        chatId = 'user_' + Math.random().toString(36).substr(2, 9);
        //localStorage.setItem('chatId', chatId);
        document.getElementById('chatIdDisplay').innerText = chatId;
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML = '';
        appendMessage('ai', 'ğŸ”„ ä¼šè¯å·²é‡ç½®ã€‚');
    }

    async function sendMsg() {
        const input = document.getElementById('msgInput');
        const btn = document.getElementById('sendBtn');
        const text = input.value.trim();
        if (!text) return;

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆç°åœ¨ä¹Ÿæ”¯æŒ Markdown æ¸²æŸ“ï¼‰
        appendMessage('user', text);
        input.value = '';
        btn.disabled = true;

        // åˆ›å»º AI æ¶ˆæ¯å®¹å™¨
        const aiMsgDiv = appendMessage('ai', '');
        let aiResponseText = '';

        try {
            // è¿æ¥åˆ°åç«¯ EventSource æµ
            const eventSource = new EventSource(`http://localhost:8080/api/chat/stream?chatId=${chatId}&message=${encodeURIComponent(text)}`);

            eventSource.onmessage = function(event) {
                // é¦–æ¬¡æ¥æ”¶æ—¶æ¸…ç©ºåŠ è½½æç¤º
                if (aiResponseText === '') aiMsgDiv.innerHTML = '';

                // å¤„ç†è½¬ä¹‰æ¢è¡Œç¬¦ï¼ˆæ ¹æ®åç«¯å®é™…è¿”å›è°ƒæ•´ï¼‰
                const token = event.data.replace(/\\n/g, '\n');
                aiResponseText += token;

                // å®‰å…¨æ¸²æŸ“ Markdown
                try {
                    const rawHtml = marked.parse(aiResponseText);
                    aiMsgDiv.innerHTML = DOMPurify.sanitize(rawHtml, {
                        ALLOWED_TAGS: [...DOMPurify.defaults.ALLOWED_TAGS, 'img', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'code', 'pre', 'table', 'thead', 'tbody', 'tr', 'th', 'td'],
                        ALLOWED_ATTR: [...DOMPurify.defaults.ALLOWED_ATTR, 'src', 'alt', 'width', 'height', 'align']
                    });
                } catch (e) {
                    // é™çº§ä¸ºçº¯æ–‡æœ¬ï¼ˆä¿ç•™æ¢è¡Œï¼‰
                    aiMsgDiv.innerText = aiResponseText;
                    console.warn('Markdown è§£æå¤±è´¥ï¼Œé™çº§ä¸ºçº¯æ–‡æœ¬:', e);
                }

                // æ»šåŠ¨åˆ°åº•éƒ¨
                document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            };

            eventSource.onerror = function() {
                eventSource.close();
                btn.disabled = false;
                if (aiResponseText === '') {
                    aiMsgDiv.innerHTML = DOMPurify.sanitize(marked.parse('âš ï¸ è¿æ¥ä¸­æ–­ï¼Œè¯·é‡è¯•ã€‚'));
                }
            };

            eventSource.onopen = function() {
                // å¯é€‰ï¼šè¿æ¥æˆåŠŸæç¤º
            };
        } catch (error) {
            aiMsgDiv.innerHTML = DOMPurify.sanitize(marked.parse(`âŒ é”™è¯¯: ${error.message}`));
            btn.disabled = false;
        }
    }

    function appendMessage(role, text) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${role}`;

        // ç»Ÿä¸€ä½¿ç”¨ Markdown æ¸²æŸ“ï¼Œæ— è®ºæ˜¯ç”¨æˆ·æ¶ˆæ¯è¿˜æ˜¯ AI æ¶ˆæ¯
        if (text) {
            try {
                const rawHtml = marked.parse(text);
                div.innerHTML = DOMPurify.sanitize(rawHtml, {
                    ALLOWED_TAGS: [...DOMPurify.defaults.ALLOWED_TAGS, 'img', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'code', 'pre', 'table', 'thead', 'tbody', 'tr', 'th', 'td'],
                    ALLOWED_ATTR: [...DOMPurify.defaults.ALLOWED_ATTR, 'src', 'alt', 'width', 'height', 'align']
                });
            } catch {
                // å¦‚æœ Markdown è§£æå¤±è´¥ï¼Œé™çº§ä¸ºçº¯æ–‡æœ¬
                div.textContent = text;
            }
        }

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }
</script>
</body>
</html>