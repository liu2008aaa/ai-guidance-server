<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Qwen + LangChain4j Stream Chat</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f7fa; }
        .chat-container { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 10px 15px; border-radius: 8px; max-width: 80%; line-height: 1.5; }
        .user { align-self: flex-end; background: #007bff; color: white; }
        .ai { align-self: flex-start; background: #e9ecef; color: #333; }
        .input-area { margin-top: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        button { padding: 12px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
        .config { margin-bottom: 15px; font-size: 0.9em; color: #666; }
    </style>
</head>
<body>

<h2>ğŸ¤– LangChain4j + Qwen Chat</h2>

<div class="config">
    å½“å‰ä¼šè¯ ID: <span id="chatIdDisplay" style="font-weight:bold"></span>
    <button onclick="resetChat()" style="padding: 5px 10px; font-size: 0.8em; margin-left: 10px; background: #6c757d;">é‡ç½®ä¼šè¯</button>
</div>

<div class="chat-container" id="chatBox">
    <div class="message ai">ä½ å¥½ï¼æˆ‘æ˜¯é€šä¹‰åƒé—®åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ ï¼Ÿ</div>
</div>

<div class="input-area">
    <input type="text" id="msgInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." onkeypress="if(event.keyCode==13) sendMsg()">
    <button onclick="sendMsg()" id="sendBtn">å‘é€</button>
</div>

<script>
    // ç”Ÿæˆæˆ–è·å–éšæœº ChatId ä»¥æ¨¡æ‹Ÿä¸åŒç”¨æˆ·
    let chatId = localStorage.getItem('chatId') || 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('chatId', chatId);
    document.getElementById('chatIdDisplay').innerText = chatId;

    function resetChat() {
        chatId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chatId', chatId);
        document.getElementById('chatIdDisplay').innerText = chatId;
        document.getElementById('chatBox').innerHTML = '<div class="message ai">ä¼šè¯å·²é‡ç½®ã€‚</div>';
    }

    async function sendMsg() {
        const input = document.getElementById('msgInput');
        const btn = document.getElementById('sendBtn');
        const text = input.value.trim();
        if (!text) return;

        // 1. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
        appendMessage('user', text);
        input.value = '';
        btn.disabled = true;

        // 2. åˆ›å»ºAIæ¶ˆæ¯å ä½ç¬¦
        const aiMsgDiv = appendMessage('ai', '...');
        let aiResponseText = '';

        try {
            // 3. å‘èµ· SSE è¯·æ±‚ (EventSource)
            const eventSource = new EventSource(`http://localhost:8080/api/chat/stream?chatId=${chatId}&message=${encodeURIComponent(text)}`);

            // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯æµ
            eventSource.onmessage = function(event) {
                if (aiResponseText === '') aiMsgDiv.innerHTML = ''; // æ¸…é™¤ loading çŠ¶æ€

                // ç®€å•çš„æ¢è¡Œå¤„ç†ï¼Œå®é™…å¯ä»¥ä½¿ç”¨ Markdown è§£æåº“ (å¦‚ marked.js)
                const token = event.data.replace(/\\n/g, '\n');
                aiResponseText += token;
                aiMsgDiv.innerText = aiResponseText;

                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                const chatBox = document.getElementById('chatBox');
                chatBox.scrollTop = chatBox.scrollHeight;
            };

            eventSource.onerror = function(err) {
                eventSource.close();
                btn.disabled = false;
                console.log("Stream ended or error occurred");
            };

        } catch (error) {
            aiMsgDiv.innerText = "Error: " + error.message;
            btn.disabled = false;
        }
    }

    function appendMessage(role, text) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        div.innerText = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }
</script>
</body>
</html>