<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Qwen + LangChain4j Stream Chat (Markdown)</title>
    <!-- å¼•å…¥ Markdown è§£æåº“å’Œå®‰å…¨å‡€åŒ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f7fa; }
        .chat-container { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 15px; border-radius: 8px; max-width: 85%; line-height: 1.6; word-wrap: break-word; }
        .user { align-self: flex-end; background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .ai { align-self: flex-start; background: #f1f3f4; color: #202124; }
        .input-area { margin-top: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; outline: none; font-size: 14px; }
        button { padding: 12px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .config { margin-bottom: 15px; padding: 10px; background: #e9ecef; border-radius: 5px; font-size: 0.9em; color: #495057; }

        /* Markdown é€šç”¨æ ·å¼ */
        .message h1, .message h2, .message h3, .message h4 { margin-top: 0.5em; margin-bottom: 0.3em; }
        .message h1 { font-size: 1.4em; }
        .message h2 { font-size: 1.3em; }
        .message h3 { font-size: 1.2em; }
        .message h4 { font-size: 1.1em; }
        .message p { margin: 0.5em 0; }
        .message ul, .message ol { padding-left: 1.5em; margin: 0.5em 0; }
        .message li { margin: 0.3em 0; }
        .message blockquote { margin: 0.5em 0; padding-left: 1em; border-left: 3px solid rgba(0,0,0,0.1); color: #555; }
        .message hr { border: none; border-top: 1px solid rgba(0,0,0,0.1); margin: 1em 0; }

        /* ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ Markdown æ ·å¼ */
        .message.user h1, .message.user h2, .message.user h3, .message.user h4 { color: #e6f2ff; }
        .message.user a { color: #b3d7ff; text-decoration: underline; }
        .message.user blockquote { border-left-color: rgba(255,255,255,0.3); color: #e6f2ff; }
        .message.user code { background: rgba(255,255,255,0.2); color: #e6f2ff; }
        .message.user pre { background: rgba(0,0,0,0.2); }

        /* AI æ¶ˆæ¯ä¸­çš„ Markdown æ ·å¼ */
        .message.ai h1, .message.ai h2, .message.ai h3, .message.ai h4 { color: #202124; }
        .message.ai a { color: #1a73e8; text-decoration: underline; }
        .message.ai a:hover { text-decoration: none; }
        .message.ai img { max-width: 100%; border-radius: 4px; margin: 0.5em 0; }
        .message.ai pre { background: #f8f9fa; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 0.5em 0; border: 1px solid #e9ecef; }
        .message.ai code { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9em; background: #f1f3f5; padding: 2px 6px; border-radius: 3px; color: #d63384; }
        .message.ai pre code { background: transparent; padding: 0; color: inherit; }
        .message.ai blockquote { border-left: 3px solid #007bff; padding-left: 12px; margin-left: 0; color: #555; background: rgba(0,123,255,0.05); padding-top: 4px; padding-bottom: 4px; }
        .message.ai table { border-collapse: collapse; width: 100%; margin: 0.5em 0; }
        .message.ai th, .message.ai td { border: 1px solid #dee2e6; padding: 8px; text-align: left; }
        .message.ai th { background-color: #f8f9fa; font-weight: bold; }
        .message.ai tr:nth-child(even) { background-color: #f8f9fa; }
    </style>
</head>
<body>

<h2>ğŸ¤– LangChain4j + Qwen Chat (Markdown)</h2>

<div class="config">
    å½“å‰ä¼šè¯ ID: <span id="chatIdDisplay" style="font-weight:bold"></span>
    <button onclick="resetChat()" style="padding: 5px 10px; font-size: 0.8em; margin-left: 10px; background: #6c757d;">é‡ç½®ä¼šè¯</button>
    <div style="margin-top: 5px; font-size: 0.85em;">æç¤ºï¼šç”¨æˆ·å’ŒAIæ¶ˆæ¯éƒ½æ”¯æŒMarkdownæ ¼å¼æ˜¾ç¤º</div>
</div>

<div class="chat-container" id="chatBox">
    <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯æ”¹ä¸º JS åŠ¨æ€æ·»åŠ ï¼Œç¡®ä¿æ”¯æŒ Markdown -->
</div>

<div class="input-area">
    <input type="text" id="msgInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼ˆæ”¯æŒMarkdownæ ¼å¼ï¼‰..." onkeypress="if(event.keyCode==13) sendMsg()">
    <button onclick="sendMsg()" id="sendBtn">å‘é€</button>
</div>

<script>
    // é…ç½® markedï¼šå¯ç”¨ GitHub é£æ ¼ Markdown å’Œå•æ¢è¡Œè½¬ <br>
    marked.setOptions({
        breaks: true,  // å•æ¢è¡Œè½¬ <br>
        gfm: true,     // å¯ç”¨ GitHub Flavored Markdown
        headerIds: false, // ä¸è‡ªåŠ¨ç”Ÿæˆ header id
        mangle: false  // ä¸è‡ªåŠ¨è½¬æ¢ header æ–‡æœ¬
    });

    // ç”Ÿæˆæˆ–è·å–éšæœº ChatId
    let chatId = 'user_' + Math.random().toString(36).substr(2, 9);
    document.getElementById('chatIdDisplay').innerText = chatId;

    // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯ï¼ˆæ”¯æŒ Markdownï¼‰
    window.addEventListener('load', () => {
        appendMessage('ai', 'ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯é€šä¹‰åƒé—®åŠ©æ‰‹ï¼Œ**æ‰€æœ‰æ¶ˆæ¯éƒ½æ”¯æŒMarkdownæ ¼å¼**ï¼š\n\n## åŠŸèƒ½ç¤ºä¾‹\n- **ç²—ä½“æ–‡æœ¬** å’Œ *æ–œä½“æ–‡æœ¬*\n- `è¡Œå†…ä»£ç ` å’Œ ä»£ç å—\n- åˆ—è¡¨ã€è¡¨æ ¼å’Œå¼•ç”¨\n- æ•°å­¦å…¬å¼ï¼š$E = mc^2$\n\næœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ ï¼Ÿ');
    });

    function resetChat() {
        chatId = 'user_' + Math.random().toString(36).substr(2, 9);
        document.getElementById('chatIdDisplay').innerText = chatId;
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML = '';
        appendMessage('ai', 'ğŸ”„ ä¼šè¯å·²é‡ç½®ã€‚\n\næ–°çš„ä¼šè¯IDï¼š`' + chatId + '`');
    }

    async function sendMsg() {
        const input = document.getElementById('msgInput');
        const btn = document.getElementById('sendBtn');
        const text = input.value.trim();
        if (!text) return;

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆä½¿ç”¨Markdownæ¸²æŸ“ï¼‰
        appendMessage('user', text);
        input.value = '';
        btn.disabled = true;

        // åˆ›å»º AI æ¶ˆæ¯å®¹å™¨
        const aiMsgDiv = appendMessage('ai', '');
        let aiResponseText = '';

        try {
            // æ¨¡æ‹Ÿæµå¼å“åº”ï¼ˆå®é™…ä½¿ç”¨æ—¶æ›¿æ¢ä¸ºæ‚¨çš„APIè°ƒç”¨ï¼‰
            simulateStreamingResponse(text, aiMsgDiv, btn);

            // å®é™…ä½¿ç”¨æ—¶å–æ¶ˆæ³¨é‡Šä»¥ä¸‹ä»£ç ï¼Œå¹¶åˆ é™¤ä¸Šé¢çš„simulateStreamingResponseè°ƒç”¨
            /*
            const eventSource = new EventSource(`http://localhost:8080/api/chat/stream?chatId=${chatId}&message=${encodeURIComponent(text)}`);

            eventSource.onmessage = function(event) {
                // é¦–æ¬¡æ¥æ”¶æ—¶æ¸…ç©ºåŠ è½½æç¤º
                if (aiResponseText === '') aiMsgDiv.innerHTML = '';

                // å¤„ç†è½¬ä¹‰æ¢è¡Œç¬¦ï¼ˆæ ¹æ®åç«¯å®é™…è¿”å›è°ƒæ•´ï¼‰
                const token = event.data.replace(/\\n/g, '\n');
                aiResponseText += token;

                // å®‰å…¨æ¸²æŸ“ Markdown
                renderMarkdown(aiMsgDiv, aiResponseText);

                // æ»šåŠ¨åˆ°åº•éƒ¨
                document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            };

            eventSource.onerror = function() {
                eventSource.close();
                btn.disabled = false;
                if (aiResponseText === '') {
                    renderMarkdown(aiMsgDiv, 'âš ï¸ è¿æ¥ä¸­æ–­ï¼Œè¯·é‡è¯•ã€‚');
                }
            };
            */
        } catch (error) {
            renderMarkdown(aiMsgDiv, `âŒ é”™è¯¯: ${error.message}`);
            btn.disabled = false;
        }
    }

    // æ¸²æŸ“Markdownå†…å®¹çš„è¾…åŠ©å‡½æ•°
    function renderMarkdown(element, markdownText) {
        try {
            const rawHtml = marked.parse(markdownText);
            element.innerHTML = DOMPurify.sanitize(rawHtml, {
                ALLOWED_TAGS: [...DOMPurify.defaults.ALLOWED_TAGS, 'img', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'code', 'pre', 'table', 'thead', 'tbody', 'tr', 'th', 'td'],
                ALLOWED_ATTR: [...DOMPurify.defaults.ALLOWED_ATTR, 'src', 'alt', 'width', 'height', 'align']
            });
        } catch (e) {
            // é™çº§ä¸ºçº¯æ–‡æœ¬ï¼ˆä¿ç•™æ¢è¡Œï¼‰
            element.textContent = markdownText;
            console.warn('Markdown è§£æå¤±è´¥ï¼Œé™çº§ä¸ºçº¯æ–‡æœ¬:', e);
        }
    }

    function appendMessage(role, text) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${role}`;

        // ä¸ºæ‰€æœ‰æ¶ˆæ¯æ¸²æŸ“Markdownæ ¼å¼
        if (text) {
            renderMarkdown(div, text);
        }

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }

    // æ¨¡æ‹Ÿæµå¼å“åº”çš„å‡½æ•°ï¼ˆæ¼”ç¤ºç”¨ï¼Œå®é™…ä½¿ç”¨æ—¶åˆ é™¤ï¼‰
    function simulateStreamingResponse(userInput, aiMsgDiv, btn) {
        const responses = [
            "æˆ‘ç†è§£äº†ä½ çš„é—®é¢˜ï¼\n\nä½ è¾“å…¥çš„æ˜¯ï¼š\n```\n" + userInput + "\n```\n\nè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹...",
            "## åˆ†æç»“æœ\n\næ ¹æ®ä½ çš„è¾“å…¥ï¼Œæˆ‘å¯ä»¥æä¾›ä»¥ä¸‹å»ºè®®ï¼š\n\n1. **é¦–å…ˆ**ï¼Œè€ƒè™‘é—®é¢˜çš„èƒŒæ™¯\n2. **å…¶æ¬¡**ï¼Œåˆ†æç›¸å…³å› ç´ \n3. **æœ€å**ï¼Œåˆ¶å®šè§£å†³æ–¹æ¡ˆ\n\n### ä»£ç ç¤ºä¾‹\n```python\ndef solution():\n    print('Hello, Markdown!')\n    return True\n```",
            "### æ€»ç»“\n\nè¿™ä¸ªé—®é¢˜çš„å…³é”®ç‚¹åŒ…æ‹¬ï¼š\n- ç”¨æˆ·éœ€æ±‚ï¼š`" + userInput + "`\n- æŠ€æœ¯å®ç°ï¼šä½¿ç”¨ **Markdown** æ ¼å¼å±•ç¤º\n- ç”¨æˆ·ä½“éªŒï¼šæµå¼å“åº”ï¼Œå®æ—¶æ¸²æŸ“\n\n> æç¤ºï¼šæ‰€æœ‰æ¶ˆæ¯éƒ½æ”¯æŒMarkdownè¯­æ³•ï¼"
        ];

        let responseIndex = 0;
        const response = responses[Math.floor(Math.random() * responses.length)];
        let currentText = '';
        let charIndex = 0;

        const interval = setInterval(() => {
            if (charIndex < response.length) {
                currentText += response.charAt(charIndex);
                renderMarkdown(aiMsgDiv, currentText + (charIndex < response.length - 1 ? 'â–Œ' : ''));
                charIndex++;
                chatBox.scrollTop = chatBox.scrollHeight;
            } else {
                clearInterval(interval);
                btn.disabled = false;
            }
        }, 30);
    }
</script>
</body>
</html>