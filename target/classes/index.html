<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Qwen + LangChain4j Stream Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f7fa; }
        .chat-container { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 10px 15px; border-radius: 8px; max-width: 80%; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; }
        .user { align-self: flex-end; background: #007bff; color: white; }
        .ai { align-self: flex-start; background: #e9ecef; color: #333; }

        /* AI æ¶ˆæ¯æ ·å¼ä¼˜åŒ– */
        .ai h1, .ai h2, .ai h3, .ai h4 { margin: 8px 0; color: #333; }
        .ai h3 { font-size: 1.2em; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
        .ai p { margin: 6px 0; }
        .ai ul, .ai ol { margin: 6px 0; padding-left: 20px; }
        .ai code { background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .ai pre { background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto; }

        /* é“¾æ¥æ ·å¼ */
        .ai a { color: #0066cc; text-decoration: underline; cursor: pointer; word-break: break-all; }
        .ai a:hover { color: #0052a3; background-color: rgba(0,102,204,0.1); }
        .ai a[href^="http"]:after { content: " â†—"; font-size: 0.8em; opacity: 0.7; }

        .input-area { margin-top: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; outline: none; font-size: 14px; }
        button { padding: 12px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .config { margin-bottom: 15px; font-size: 0.9em; color: #666; display: flex; align-items: center; }

        /* åŠ è½½åŠ¨ç”» */
        .typing-indicator { color: #999; font-style: italic; }
    </style>
</head>
<body>

<h2>ğŸ¤– LangChain4j + Qwen Chat</h2>

<div class="config">
    å½“å‰ä¼šè¯ ID: <span id="chatIdDisplay" style="font-weight:bold; margin-right: 10px;"></span>
    <button onclick="resetChat()" style="padding: 5px 10px; font-size: 0.8em; background: #6c757d;">é‡ç½®ä¼šè¯</button>
</div>

<div class="chat-container" id="chatBox">
    <div class="message ai">ä½ å¥½ï¼æˆ‘æ˜¯é€šä¹‰åƒé—®åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ ï¼Ÿ</div>
</div>

<div class="input-area">
    <input type="text" id="msgInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." onkeypress="if(event.keyCode==13) sendMsg()">
    <button onclick="sendMsg()" id="sendBtn">å‘é€</button>
</div>

<script>
    // ========== åˆå§‹åŒ–é…ç½® ==========
    marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false,
        sanitize: false // äº¤ç»™ DOMPurify å¤„ç†
    });

    // å¼ºåˆ¶é“¾æ¥æ–°å¼€æ ‡ç­¾é¡µ
    DOMPurify.addHook('afterSanitizeAttributes', function(node) {
        if (node.tagName === 'A') {
            node.setAttribute('target', '_blank');
            node.setAttribute('rel', 'noopener noreferrer');
        }
    });

    // ä¿®å¤ Markdown å¸¸è§æ ¼å¼é”™è¯¯ï¼ˆç‰¹åˆ«æ˜¯ä¸­æ–‡åœºæ™¯ï¼‰
    function fixMarkdownFormat(text) {
        // ä¿®å¤æ ‡é¢˜ï¼š###æ ‡é¢˜ â†’ ### æ ‡é¢˜
        text = text.replace(/^(#{1,6})([^#\s])/gm, '$1 $2');
        // ä¿®å¤åˆ—è¡¨ï¼š-item â†’ - item
        text = text.replace(/^([*-])([^*\s])/gm, '$1 $2');
        // ä¿®å¤å¼•ç”¨ï¼š>quote â†’ > quote
        text = text.replace(/^(>)([^>\s])/gm, '$1 $2');
        return text;
    }

    // å®‰å…¨çš„ Markdown æ¸²æŸ“
    function renderSafeMarkdown(markdownText) {
        const fixedText = fixMarkdownFormat(markdownText);
        const rawHtml = marked.parse(fixedText);
        return DOMPurify.sanitize(rawHtml, {
            ALLOWED_TAGS: [
                'p', 'br', 'strong', 'b', 'em', 'i', 'u', 'del', 's',
                'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                'a', 'ul', 'ol', 'li', 'code', 'pre', 'blockquote', 'hr'
            ],
            ALLOWED_ATTR: ['href', 'title', 'target', 'rel', 'class']
        });
    }

    // ========== ä¼šè¯ç®¡ç† ==========
    let chatId = localStorage.getItem('chatId') || 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('chatId', chatId);
    document.getElementById('chatIdDisplay').innerText = chatId;

    function resetChat() {
        chatId = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chatId', chatId);
        document.getElementById('chatIdDisplay').innerText = chatId;
        document.getElementById('chatBox').innerHTML = '<div class="message ai">ä¼šè¯å·²é‡ç½®ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ</div>';
    }

    // ========== æ ¸å¿ƒèŠå¤©é€»è¾‘ ==========
    let isStreaming = false;

    async function sendMsg() {
        const input = document.getElementById('msgInput');
        const btn = document.getElementById('sendBtn');
        const text = input.value.trim();

        if (!text || isStreaming) return;

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        appendMessage('user', text, false);
        input.value = '';
        btn.disabled = true;
        isStreaming = true;

        // åˆ›å»º AI æ¶ˆæ¯å®¹å™¨ï¼ˆåˆå§‹æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼‰
        const aiMsgDiv = appendMessage('ai', '<span class="typing-indicator">æ€è€ƒä¸­...</span>', true);
        let aiRawMarkdown = '';
        let renderTimer = null;
        const RENDER_DELAY = 60; // 60ms é˜²æŠ–ï¼Œå¹³è¡¡æµç•…åº¦å’Œè¯­æ³•æ­£ç¡®æ€§

        // é˜²æŠ–æ¸²æŸ“å‡½æ•°ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šä¸å†ä½¿ç”¨ textContentï¼Œé¿å…é—ªçƒï¼‰
        const debounceRender = () => {
            if (renderTimer) clearTimeout(renderTimer);
            renderTimer = setTimeout(() => {
                if (aiRawMarkdown.length > 0) {
                    aiMsgDiv.innerHTML = renderSafeMarkdown(aiRawMarkdown);
                    // è‡ªåŠ¨æ»šåŠ¨
                    const chatBox = document.getElementById('chatBox');
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }, RENDER_DELAY);
        };

        try {
            const eventSource = new EventSource(
                `http://localhost:8080/api/chat/stream?chatId=${chatId}&message=${encodeURIComponent(text)}`
            );

            eventSource.onmessage = function(event) {
                const token = event.data;

                // é¦–æ¬¡æ”¶åˆ°æ•°æ®ï¼Œæ¸…é™¤"æ€è€ƒä¸­..."
                if (aiRawMarkdown === '') {
                    aiMsgDiv.innerHTML = ''; // åªæ¸…ä¸€æ¬¡
                }

                // ç´¯ç§¯åŸå§‹ Markdown
                aiRawMarkdown += token;

                // é˜²æŠ–æ¸²æŸ“ï¼ˆå…³é”®ï¼šä¸è®¾ç½® textContentï¼Œç›´æ¥ç­‰é˜²æŠ–æ›´æ–° innerHTMLï¼‰
                debounceRender();
            };

            eventSource.onerror = function(err) {
                // æµç»“æŸæˆ–å‡ºé”™
                if (renderTimer) clearTimeout(renderTimer);
                eventSource.close();
                isStreaming = false;
                btn.disabled = false;

                // æœ€ç»ˆå¼ºåˆ¶æ¸²æŸ“ï¼ˆç¡®ä¿æ‰€æœ‰ Markdown é—­åˆï¼‰
                if (aiRawMarkdown.length > 0) {
                    aiMsgDiv.innerHTML = renderSafeMarkdown(aiRawMarkdown);
                } else {
                    aiMsgDiv.innerHTML = '<span style="color:#999">[æ— å“åº”]</span>';
                }

                // æœ€ç»ˆæ»šåŠ¨
                const chatBox = document.getElementById('chatBox');
                chatBox.scrollTop = chatBox.scrollHeight;
            };

        } catch (error) {
            if (renderTimer) clearTimeout(renderTimer);
            aiMsgDiv.innerText = "Error: " + error.message;
            btn.disabled = false;
            isStreaming = false;
        }
    }

    function appendMessage(role, content, isHtml) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${role}`;

        if (isHtml && role === 'ai') {
            div.innerHTML = content;
        } else {
            div.textContent = content; // ç”¨æˆ·æ¶ˆæ¯å§‹ç»ˆçº¯æ–‡æœ¬ï¼ˆå®‰å…¨ï¼‰
        }

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }
</script>
</body>
</html>